CC = gcc
CFLAGS = -Wall -Wextra -g
LDFLAGS = 

# Fichiers objets communs
COMMON_OBJ = common.o
ADDR ?= 127.0.0.1
PORT ?= 8080

# Ports des serveurs sp√©cialis√©s
PORT_DATE = 8081
PORT_FILES = 8082
PORT_CONTENT = 8083
PORT_STATS = 8084

# Tous les ex√©cutables
ALL = serverTCP server_date server_files server_content server_stats clientTCP

.PHONY: all clean clean-ports stop run help

all: $(ALL)

# Compilation de common.o
common.o: common.c common.h
	$(CC) $(CFLAGS) -c common.c -o common.o

# serverTCP (serveur principal)
serverTCP: serverTCP.c $(COMMON_OBJ)
	$(CC) $(CFLAGS) serverTCP.c $(COMMON_OBJ) -o serverTCP $(LDFLAGS)

# Serveur sp√©cialis√©: Date
server_date: server_date.c $(COMMON_OBJ)
	$(CC) $(CFLAGS) server_date.c $(COMMON_OBJ) -o server_date $(LDFLAGS)

# Serveur sp√©cialis√©: Fichiers
server_files: server_files.c $(COMMON_OBJ)
	$(CC) $(CFLAGS) server_files.c $(COMMON_OBJ) -o server_files $(LDFLAGS)

# Serveur sp√©cialis√©: Contenu
server_content: server_content.c $(COMMON_OBJ)
	$(CC) $(CFLAGS) server_content.c $(COMMON_OBJ) -o server_content $(LDFLAGS)

# Serveur sp√©cialis√©: Stats
server_stats: server_stats.c $(COMMON_OBJ)
	$(CC) $(CFLAGS) server_stats.c $(COMMON_OBJ) -o server_stats $(LDFLAGS)

# clientTCP
clientTCP: clientTCP.c $(COMMON_OBJ)
	$(CC) $(CFLAGS) clientTCP.c $(COMMON_OBJ) -o clientTCP $(LDFLAGS)

# Nettoyer les ports - Tue les processus utilisant les ports
clean-ports:
	@echo "üßπ Nettoyage des ports des serveurs..."
	@echo "üî´ Arr√™t des processus sur les ports $(PORT), $(PORT_DATE), $(PORT_FILES), $(PORT_CONTENT), $(PORT_STATS)..."
	
	# M√©thode 1: Utiliser fuser (Linux)
	@-for p in $(PORT) $(PORT_DATE) $(PORT_FILES) $(PORT_CONTENT) $(PORT_STATS); do \
		if command -v fuser >/dev/null 2>&1; then \
			fuser -k $${p}/tcp 2>/dev/null || true; \
		fi; \
	done
	
	# M√©thode 2: Utiliser pkill avec les noms des ex√©cutables
	@-pkill -f "serverTCP" || true
	@-pkill -f "server_date" || true
	@-pkill -f "server_files" || true
	@-pkill -f "server_content" || true
	@-pkill -f "server_stats" || true
	
	# M√©thode 3: Utiliser killall (Linux)
	@-if command -v killall >/dev/null 2>&1; then \
		killall serverTCP 2>/dev/null || true; \
		killall server_date 2>/dev/null || true; \
		killall server_files 2>/dev/null || true; \
		killall server_content 2>/dev/null || true; \
		killall server_stats 2>/dev/null || true; \
	fi
	
	# M√©thode 4: Cygwin/Windows - utiliser taskkill
	@-if [ "$$(uname -o 2>/dev/null)" = "Cygwin" ]; then \
		for p in $(PORT) $(PORT_DATE) $(PORT_FILES) $(PORT_CONTENT) $(PORT_STATS); do \
			netstat -ano | grep ":$$p " | awk '{print $$5}' | while read pid; do \
				taskkill /F /PID $$pid 2>/dev/null || true; \
			done; \
		done; \
	fi
	
	@sleep 2
	@echo " Ports nettoy√©s et processus arr√™t√©s"

# Arr√™ter tous les serveurs (alias de clean-ports)
stop: clean-ports
	@echo " Tous les serveurs ont √©t√© arr√™t√©s"

# Nettoyage complet - Arr√™te les serveurs ET supprime les fichiers
clean: clean-ports
	@echo " Suppression des fichiers ex√©cutables et temporaires..."
	rm -f $(ALL) *.o users.txt server_info.txt
	rm -rf logs_test_*
	@echo "Nettoyage complet effectu√©"

# Lancer tous les serveurs en arri√®re-plan
run: all clean-ports
	@echo " D√©marrage de l'√©cosyst√®me multiserveur..."
	@echo " Configuration:"
	@echo "   - Proxy principal: $(ADDR):$(PORT)"
	@echo "   - Service Date: port $(PORT_DATE)"
	@echo "   - Service Fichiers: port $(PORT_FILES)"
	@echo "   - Service Contenu: port $(PORT_CONTENT)"
	@echo "   - Service Stats: port $(PORT_STATS)"
	@echo ""
	
	@echo "=== D√©marrage des serveurs sp√©cialis√©s ==="
	@echo "Lancement serveur Date..."
	@./server_date > server_date.log 2>&1 &
	@sleep 1
	
	@echo " Lancement serveur Fichiers..."
	@./server_files > server_files.log 2>&1 &
	@sleep 1
	
	@echo " Lancement serveur Contenu..."
	@./server_content > server_content.log 2>&1 &
	@sleep 1
	
	@echo "  Lancement serveur Stats..."
	@./server_stats > server_stats.log 2>&1 &
	@sleep 2
	
	@echo " Tous les serveurs sp√©cialis√©s d√©marr√©s en arri√®re-plan"
	@echo " Logs disponibles dans: server_*.log"
	@echo ""
	
	@echo "=== D√©marrage du serveur principal (Proxy) ==="
	@echo " Serveur principal sur $(ADDR):$(PORT)..."
	./serverTCP $(ADDR) $(PORT)

# Lancer seulement le client
client: clientTCP
	@echo " Lancement du client..."
	./clientTCP

# V√©rifier l'√©tat des serveurs
status:
	@echo " √âtat des serveurs:"
	@echo "Port $(PORT) (Proxy): $$(if lsof -Pi :$(PORT) -sTCP:LISTEN -t >/dev/null; then echo "‚úÖ En √©coute"; else echo "‚ùå Arr√™t√©"; fi)"
	@echo "Port $(PORT_DATE) (Date): $$(if lsof -Pi :$(PORT_DATE) -sTCP:LISTEN -t >/dev/null; then echo "‚úÖ En √©coute"; else echo "‚ùå Arr√™t√©"; fi)"
	@echo "Port $(PORT_FILES) (Fichiers): $$(if lsof -Pi :$(PORT_FILES) -sTCP:LISTEN -t >/dev/null; then echo "‚úÖ En √©coute"; else echo "‚ùå Arr√™t√©"; fi)"
	@echo "Port $(PORT_CONTENT) (Contenu): $$(if lsof -Pi :$(PORT_CONTENT) -sTCP:LISTEN -t >/dev/null; then echo "‚úÖ En √©coute"; else echo "‚ùå Arr√™t√©"; fi)"
	@echo "Port $(PORT_STATS) (Stats): $$(if lsof -Pi :$(PORT_STATS) -sTCP:LISTEN -t >/dev/null; then echo "‚úÖ En √©coute"; else echo "‚ùå Arr√™t√©"; fi)"
	
	@echo ""
	@echo " Processus en cours:"
	@pgrep -fl "server_" || echo "Aucun processus serveur trouv√©"

# Aide
help:
	@echo "Usage du Makefile - Syst√®me Multiserveur:"
	@echo ""
	@echo "  make all           - Compiler tous les programmes"
	@echo "  make run           - Lancer tous les serveurs (d√©faut: 127.0.0.1:8080)"
	@echo "  make run ADDR=<ip> PORT=<port> - Lancer avec IP/port personnalis√©s"
	@echo "  make client        - Lancer seulement le client"
	@echo "  make stop          - Arr√™ter tous les serveurs"
	@echo "  make clean         - Nettoyer COMPLET (arr√™te serveurs + supprime fichiers)"
	@echo "  make clean-ports   - Arr√™ter les serveurs sans supprimer les fichiers"
	@echo "  make status        - V√©rifier l'√©tat des serveurs"
	@echo ""
	@echo "Ports utilis√©s:"
	@echo "  - Proxy: $(PORT) (configurable)"
	@echo "  - Date: $(PORT_DATE)"
	@echo "  - Fichiers: $(PORT_FILES)"
	@echo "  - Contenu: $(PORT_CONTENT)"
	@echo "  - Stats: $(PORT_STATS)"
	@echo ""
	@echo "Exemples:"
	@echo "  make run ADDR=192.168.1.10 PORT=9000"
	@echo "  make run PORT=7777"
	@echo "  make clean          # Arr√™te tout et nettoie"
	@echo "  make stop           # Arr√™te les serveurs sans nettoyer"